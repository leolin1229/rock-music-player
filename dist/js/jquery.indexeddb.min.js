!function(a){"use strict";function h(a){var b=null;switch(a){case 0:case 1:case"readwrite":case"readonly":b=a;break;default:b=g.READ_WRITE||"readwrite"}return b}var g,c=!1,d=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,e=window.IDBKeyRange||window.webkitIDBKeyRange,f=window.IDBCursor||window.webkitIDBCursor||{};"undefined"==typeof f.PREV&&(f.PREV="prev"),"undefined"==typeof f.NEXT&&(f.NEXT="next"),g=window.IDBTransaction||window.webkitIDBTransaction,a.extend({indexedDB:function(b,f){var g,i,j,k,l;if(f&&("number"==typeof f&&(f={version:f}),g=f.version,f.schema&&!g)){i=-1;for(j in f.schema)i=i>j?i:j;g=f.version||i}return k={request:function(b,d){return a.Deferred(function(a){try{var e="function"==typeof b?b(d):b;e.onsuccess=function(b){c&&console.log("Success",e,b,this),a.resolveWith(e,[e.result,b])},e.onerror=function(b){c&&console.log("Error",e,b,this),a.rejectWith(e,[e.error,b])},"undefined"!=typeof e.onblocked&&null===e.onblocked&&(e.onblocked=function(b){c&&console.log("Blocked",e,b,this);var d;try{d=e.result}catch(b){d=null}a.notifyWith(e,[d,b])}),"undefined"!=typeof e.onupgradeneeded&&null===e.onupgradeneeded&&(e.onupgradeneeded=function(b){c&&console.log("Upgrade",e,b,this),a.notifyWith(e,[e.result,b])})}catch(f){f.name="exception",a.rejectWith(e,["exception",f])}})},transaction:function(a){return{objectStore:function(b){try{return k.objectStore(a.objectStore(b))}catch(c){return a.readyState!==a.DONE&&a.abort(),k.objectStore(null)}},createObjectStore:function(b,c){try{return k.objectStore(a.db.createObjectStore(b,c))}catch(d){a.readyState!==a.DONE&&a.abort()}},deleteObjectStore:function(b){try{a.db.deleteObjectStore(b)}catch(c){a.readyState!==a.DONE&&a.abort()}},abort:function(){a.abort()}}},objectStore:function(a){var d,b={},c=["add","put","get","delete","clear","count"];for(d=0;d<c.length;d++)b[c[d]]=function(b){return function(){return k.request(function(c){return a[b].apply(a,c)},arguments)}}(c[d]);return b.each=function(b,c,d){return k.cursor(function(){return d?a.openCursor(k.range(c),d):a.openCursor(k.range(c))},b)},b.index=function(b){return k.index(function(){return a.index(b)})},b.createIndex=function(b,c,d){return 2===arguments.length&&"string"==typeof c&&(d=arguments[1],c=null),d||(d=b),k.index(function(){return a.createIndex(d,b,c)})},b.deleteIndex=function(b){return a.deleteIndex(b)},b},range:function(b){return a.isArray(b)?1===b.length?e.only(b[0]):e.bound(b[0],b[1],"undefined"==typeof b[2]?!1:b[2],"undefined"==typeof b[3]?!1:b[3]):"undefined"==typeof b?null:b},cursor:function(b,d){return a.Deferred(function(a){try{c&&console.log("Cursor request created",b);var e="function"==typeof b?b():b;e.onsuccess=function(b){var f,g;if(c&&console.log("Cursor successful"),!e.result)return a.resolveWith(e,[null,b]),void 0;f={"delete":function(){return k.request(function(){return e.result["delete"]()})},update:function(a){return k.request(function(){return e.result.update(a)})},next:function(a){this.data=a},key:e.result.key,value:e.result.value},c&&console.log("Cursor in progress",f,b),a.notifyWith(e,[f,b]),g=d.apply(e,[f]),c&&console.log("Iteration function returned",g);try{g===!1?a.resolveWith(e,[null,b]):"number"==typeof g?e.result.advance.apply(e.result,[g]):f.data?e.result["continue"].apply(e.result,[f.data]):e.result["continue"]()}catch(b){c&&console.log("Exception when trying to advance cursor",e,b),a.rejectWith(e,[e.result,b])}},e.onerror=function(b){c&&console.log("Cursor request errored out",b),a.rejectWith(e,[e.result,b])}}catch(f){c&&console.log("An exception occured inside cursor",e,f),f.type="exception",a.rejectWith(e,[null,f])}})},index:function(a){try{var b="function"==typeof a?a():a}catch(d){b=null}return c&&console.log(b,a),{each:function(a,c,d){return k.cursor(function(){return d?b.openCursor(k.range(c),d):b.openCursor(k.range(c))},a)},eachKey:function(a,c,d){return k.cursor(function(){return d?b.openKeyCursor(k.range(c),d):b.openKeyCursor(k.range(c))},a)},get:function(a){return"function"==typeof b.get?k.request(b.get(a)):b.openCursor(k.range(a))},count:function(){if("function"==typeof b.count)return k.request(b.count());throw"Count not implemented for cursors"},getKey:function(a){return"function"==typeof b.getKey?k.request(b.getKey(a)):b.openKeyCursor(k.range(a))}}}},l=k.request(function(){return c&&console.log("尝试打开数据库版本：",g),g?d.open(b,parseInt(g)):d.open(b)}),l.then(function(a){c&&console.log("DB opened at",a.version),a.onversionchange=function(){f&&f.onversionchange&&f.onversionchange()!==!1||a.close()}},function(a){c&&console.error(a)},function(a,b){if(b&&"upgradeneeded"===b.type){if(f&&f.schema){c&&console.log("Upgrading DB to ",a.version);for(var d=b.oldVersion+1;d<=b.newVersion;d++)"function"==typeof f.schema[d]&&f.schema[d].call(this,k.transaction(this.transaction))}f&&"function"==typeof f.upgrade&&f.upgrade.call(this,k.transaction(this.transaction))}}),a.extend(l,{cmp:function(a,b){return d.cmp(a,b)},deleteDatabase:function(){return a.Deferred(function(a){l.then(function(c){c.close(),k.request(function(){return d.deleteDatabase(b)}).then(function(b,c){a.resolveWith(this,[b,c])},function(b,c){a.rejectWith(this,[b,c])},function(b,c){a.notifyWith(this,[b,c])})},function(b,c){a.rejectWith(this,[b,c])},function(b,c){a.notifyWith(this,[b,c])})})},transaction:function(b,d){return!a.isArray(b)&&(b=[b]),d=h(d),a.Deferred(function(a){l.then(function(e,f){var g;try{c&&console.log("DB Opened, now trying to create a transaction",b,d),g=e.transaction(b,d),c&&console.log("Created a transaction",g,d,b),g.onabort=g.onerror=function(b){a.rejectWith(g,[b])},g.oncomplete=function(b){a.resolveWith(g,[b])}}catch(f){return c&&console.log("Creating a traction failed",f,b,d,this),f.type="exception",a.rejectWith(this,[f]),void 0}try{a.notifyWith(g,[k.transaction(g)])}catch(f){f.type="exception",a.rejectWith(this,[f])}},function(b,c){a.rejectWith(this,[c,b])},function(a,b){c&&console.log("Database open is blocked or upgrade needed",a,b.type)})})},objectStore:function(e,g){function m(j){return a.Deferred(function(a){function m(b,d){try{c&&console.log("Finally, returning the object store",b),d(b.objectStore(e)).then(function(b,c){a.resolveWith(this,[b,c])},function(b,c){a.rejectWith(this,[b,c])})}catch(f){c&&console.log("Duh, an exception occured",f),f.name="exception",a.rejectWith(b,[f,f])}}i.transaction(e,h(g)).then(function(){c&&console.log("Transaction completed")},function(n,o){if(n.code!==n.NOT_FOUND_ERR||g!==!0&&"object"!=typeof g)a.rejectWith(this,[n,o]);else{c&&console.log("Object Not found, so will try to create one now");var p=this.result;p.close(),l=k.request(function(){return c&&console.log("Now trying to open the database again",p.version),d.open(b,(parseInt(p.version,10)||1)+1)}),l.then(function(b){c&&console.log("Database opened, tto open transaction",b.version),b.onversionchange=function(){f&&f.onversionchange&&f.onversionchange()!==!1||b.close()},i.transaction(e,h(g)).then(function(){c&&console.log("Transaction completed when trying to create object store")},function(b,c){a.rejectWith(this,[b,c])},function(a,b){c&&console.log("Transaction in progress, when object store was not found",this,a,b),m(a,j)})},function(b,c){a.rejectWith(this,[b,c])},function(b,d){if("upgradeneeded"===d.type)try{c&&console.log("Now trying to create an object store",d.type),b.createObjectStore(e,g===!0?{autoIncrement:!0}:g),c&&console.log("Object store created",e,b)}catch(f){c&&console.log("Exception when trying ot create a new object store",f),a.rejectWith(this,[f,d])}})}},function(a){c&&console.log("Transaction is in progress",a),m(a,j)})})}function n(a,b){return m(function(c){return c[a].apply(c,b)})}function o(a,b,c){return m(function(d){var e=d.index(b);return e[a].apply(e[a],c)})}var q,i=this,j={},p=["add","delete","get","put","clear","count","each"];for(q=0;q<p.length;q++)j[p[q]]=function(a){return function(){return n(a,arguments)}}(p[q]);return j.index=function(a){return{each:function(b,c,d){return o("each",a,[b,c,d])},eachKey:function(b,c,d){return o("eachKey",a,[b,c,d])},get:function(b){return o("get",a,[b])},count:function(){return o("count",a,[])},getKey:function(b){return o("getKey",a,[b])}}},j}})}}),a.indexedDB.IDBCursor=f,a.indexedDB.IDBTransaction=g,a.idb=a.indexedDB}(jQuery);