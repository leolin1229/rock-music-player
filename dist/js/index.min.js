$(document).ready(function(){"use strict";function v(){return $("#lrcContent").empty(),$("#lrcContent").css("margin-top","250px"),""==g.lrcLink?($("#lrcContent").html("<p>找不到歌词哦～</p>"),!1):($.ajax({url:g.lrcLink,type:"GET",dataType:"text",success:function(a){_(Z(a)),g.lrcStatus=!0},statusCode:{404:function(){$("#lrcContent").html("<p>找不到歌词哦～</p>")}},error:function(){$("#lrcContent").html("<p>找不到歌词哦～</p>")},beforeSend:function(){$("#lrcContent").html("<p>歌词正在载入中...</p>")}}),void 0)}function w(a){if(""==a.lrcLink){var b=arguments[1]?arguments[1]:null;$.ajax({url:"http://geci.me/api/lyric/"+a.songName+"/"+a.artistName,type:"GET",dataType:"json",success:function(c){if(c.count>0){k.array[k.currentID].lrcLink=c.result[0].lrc.toString();var d=-1;$.indexedDB("localMusicDB").objectStore("musicList").each(function(b){return b.value.galleryId==a.galleryId&&b.value.fullPath==a.fullPath?(d=b.key,!1):void 0}).done(function(){-1!=d&&$.indexedDB("localMusicDB").objectStore("musicList").put(k.array[k.currentID],d).done(function(){b&&b.attr("data-lrc",k.array[k.currentID].lrcLink),g.lrcLink=k.array[k.currentID].lrcLink})})}else b&&b.attr("data-lrc","")},error:function(){}})}}function x(a){return function(b){var c="";switch(b.code){case FileError.QUOTA_EXCEEDED_ERR:c="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:c="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:c="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:c="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:c="INVALID_STATE_ERR";break;default:c="Unknown Error"}console.log(a+": "+c)}}function A(a,b,c){var d,e,f,g,h,i,j,k;b&&(d=$("<div></div>"),d.addClass("list-row"),parseInt(a)%2?d.addClass("odd"):d.addClass("even"),d.attr("data-lrc",b.lrcLink),"#SearchList"==c||"#MyLikeList"==c?(d.attr("data-src",b.songLink),d.attr("data-albumname",b.albumName)):(d.attr("data-fullpath",b.fullPath),d.attr("data-galleryid",b.galleryId)),e=$("<div></div>"),e.addClass("list-cell c0"),e.append('<span class="list-songname">'+b.songName+"</span>"),d.append(e),f=$("<div></div>"),f.addClass("list-cell c1"),f.append('<span class="list-songname">'+b.artistName+"</span>"),d.append(f),g=$("<div></div>"),g.addClass("list-cell c2"),g.append('<span class="list-songname">'+b.albumName+"</span>"),d.append(g),"#SearchList"==c?(h=$("<div></div>"),h.addClass("song-like"),h.append('<span class="like"><i class="icon-heart"></i></span>'),d.append(h)):"#catMusicList"!=c&&(i=$("<div></div>"),i.addClass("song-delete"),i.append('<span class="delete"><i class="icon-remove-2"></i></span>'),d.append(i)),"#SearchList"==c||"#MyLikeList"==c?(j=$("<div></div>"),j.addClass("song-add"),j.append('<span class="play"><i class="icon-play"></i></span>'),d.append(j)):"#GalleryList"==c&&(j=$("<div></div>"),j.addClass("song-cat"),j.append('<span class="play"><i class="icon-hospital"></i></span>'),d.append(j)),"#RecycleList"==c&&(k=$("<div></div>"),k.addClass("song-restore"),k.append('<span class="play"><i class="icon-restart"></i></span>'),d.append(k)),$(c).append(d))}function B(a){var c=chrome.mediaGalleries.getMediaFileSystemMetadata(a);console.log("正在扫描媒体库: "+c.name),b=a.root.createReader(),b.readEntries(D,x("readEntries"))}function D(f){var g,l;if(0==f.length)return c.length>0?(g=c.shift(),console.log("扫描子目录: "+g.fullPath),b=g.createReader(),b.readEntries(D,x("readEntries"))):(a++,a<d.length&&(console.log("扫描下一首歌: "+d[a].name),B(e[d[a]]))),void 0;for(l=0;l<f.length;l++)f[l].isFile?e[d[a]].root.getFile(f[l].fullPath,{create:!1},function(a){a.file(function(b){var d,e,f,g,c=(b.size/1024/1024).toFixed(2);return 1>=c?!1:(d=chrome.mediaGalleries.getMediaFileSystemMetadata(a.filesystem).galleryId,e=a.fullPath,1==j[d+"/"+e]?!1:(j[d+"/"+e]=!0,f=b.slice(0,b.size,"MIME"),g=new FileReader,g.readAsBinaryString(f),g.onloadstart=function(){$(".scanTipsLayer").show(),$(".scanTips").empty().append("<span class='songname-tips'>正在扫描歌曲...</span>")},g.onprogress=function(a){var b,c;a.lengthComputable&&(b=Math.round(100*(a.loaded/a.total)),c=$(".percent"),100>=b&&c.css("width",b+"%"))},g.onloadend=function(a){var b,c;$(".scanTipsLayer").hide(),b=a.target.result,i++,k.len=i,c=Mp3.getMp3Info(d,b,e),$.indexedDB("localMusicDB").objectStore("musicList").add(c).done(function(){k.array.push(c),A(i,c,"#GalleryList"),h.push({tag:c.galleryId.toString()+","+c.fullPath,id:parseInt(i)})})},void 0))})}):f[l].isDirectory?c.push(f[l]):console.log("Got something other than a file or directory.");b.readEntries(D,x("readMoreEntries"))}function E(a,b){if(a&&b){if(k.currentID<0)return;$(".title .artist").text(k.array[k.currentID].artistName),$(".title .songname").text(k.array[k.currentID].songName);var c=e[a.toString()];c.root.getFile(b,{create:!1},function(a){a.file(function(a){var b=window.webkitURL.createObjectURL(a);g.setSrc(b),g.play()})})}else console.error("readFileAsPath Error")}function F(a,b){"recycleMusic"!=b?("localMusic"==b&&(a.artist=[],j={}),a.array=[]):h=[];var c=0;"localMusic"==b?$.indexedDB("localMusicDB").objectStore("musicList").each(function(b){j[b.value.galleryId+"/"+b.value.fullPath]=!0,a.array.push(b.value),A(c,b.value,"#GalleryList"),c++}).done(function(){a.len=c}):"onlineMusic"==b?$.indexedDB("onlineMusicDB").objectStore("musicList").each(function(b){a.array.push(b.value),A(c,b.value,"#MyLikeList"),c++}).done(function(){a.len=c}):"recycleMusic"==b&&$.indexedDB("onlineMusicDB").objectStore("musicList").each(function(b){a.push(b.value),A(c,b.value,"#RecycleList"),c++}).done(function(){})}function G(){var a=0;$.indexedDB("recycleMusicDB").objectStore("musicList").each(function(b){A(a,b.value,"#RecycleList"),a++}).done(function(){0==a&&$("#RecycleList").prepend("<h3>没有歌曲哦～</h3>")})}function H(){kb.array.forEach(function(a){var d=$('<div class="offline-list-row complete-offline-list-row" data-lrc="'+a.lrcLink+'" data-songname="'+a.songName+'" data-artistname="'+a.artistName+'" data-albumname="'+a.albumName+'"><div class="list-cell c0">'+a.songName+'</div><div class="list-cell c1">'+a.artistName+'</div><div class="list-cell c2">完成</div><div class="song-delete"><span class="delete"><i class="icon-remove-2"></i></span></div></div>');$("#OfflineList").prepend(d)})}function I(b){var c;b.length?(c="<span>",b.forEach(function(a){var g=chrome.mediaGalleries.getMediaFileSystemMetadata(a);g&&(d.push(g.galleryId),e[g.galleryId]=a,c+=g.name,c+="<br>"),c+="</span>"}),a=0,$("#openFileLayer .layer-body-content").html(c),$(".scan-btn").click(function(){return!1})):(c="<span>没有任何音频文件夹哦～</span>",$("#openFileLayer .layer-body-content").html(c))}function J(a,b){var c=null,d=-1;$.indexedDB("localMusicDB").objectStore("musicList").each(function(e){return e.value.galleryId==a&&e.value.fullPath==b?(c=e.value,d=e.key,!1):void 0}).done(function(){-1!=d&&$.indexedDB("localMusicDB").objectStore("musicList").delete(d).done(function(){$.indexedDB("recycleMusicDB").objectStore("musicList").add(c).done(function(){A(0,c,"#RecycleList"),h.push(c);var f=-1;k.array.forEach(function(c,d){return c.galleryId==a&&c.fullPath==b?(f=d,!1):void 0}),-1!=f&&(k.len--,k.array.splice(f,1))})})})}function L(a,b){var c=-1;$.indexedDB("recycleMusicDB").objectStore("musicList").each(function(d){return d.value.galleryId==a&&d.value.fullPath==b?(c=d.key,!1):void 0}).done(function(){-1!=c&&($.indexedDB("recycleMusicDB").objectStore("musicList").delete(c).done(function(){h.forEach(function(d,e){d.galleryId==a&&d.fullPath==b&&$.indexedDB("localMusicDB").objectStore("musicList").add(d).done(function(){c=e,k.array.push(d),k.len++,A(0,d,"#GalleryList")})}),-1!=c&&h.splice(c,1)}),c=-1)})}function M(){$.indexedDB("localMusicDB",{version:1,schema:{1:function(a){var b=a.createObjectStore("musicList",{autoIncrement:!0});b.createIndex("artistName"),b.createIndex("albumName"),b.createIndex("songName"),b.createIndex("galleryId")}}}).done(function(){})}function N(){$.indexedDB("onlineMusicDB",{version:1,schema:{1:function(a){var b=a.createObjectStore("musicList",{autoIncrement:!0});b.createIndex("artistName"),b.createIndex("albumName"),b.createIndex("songName")}}}).done(function(){})}function O(){$.indexedDB("recycleMusicDB",{version:1,schema:{1:function(a){a.createObjectStore("musicList",{autoIncrement:!0})}}}).done(function(){})}function P(){$.indexedDB("offlineMusicDB",{version:1,schema:{1:function(a){var b=a.createObjectStore("musicList",{autoIncrement:!0});b.createIndex("artistName"),b.createIndex("albumName"),b.createIndex("songName")}}}).done(function(){})}function Q(){$.indexedDB("categoryDB",{version:1,schema:{1:function(a){var b=a.createObjectStore("categoryList",{autoIncrement:!0});b.createIndex("id")}}})}function R(a){var b=-1;return kb.array.forEach(function(c,d){return c.songName==a.songName&&c.artistName==a.artistName&&c.albumName==a.albumName?(b=d,!1):void 0}),b}function S(a){var b=-1;return k.array.forEach(function(c,d){return X(a,c)?(b=d,!1):void 0}),b}function T(a){var b=-1;return l.array.forEach(function(c,d){return Y(a,c)?(b=d,!1):void 0}),b}function U(a,b){var c=-1;$.indexedDB("recycleMusicDB").objectStore("musicList").each(function(d){return d.value.galleryId==a&&d.value.fullPath==b?(c=d.key,!1):void 0}).done(function(){-1!=c&&$.indexedDB("recycleMusicDB").objectStore("musicList").delete(c).done(function(){var d;h.forEach(function(b,c){return b.galleryId==a&&b.fullPath==b.fullPath?(d=c,!1):void 0}),-1!=d&&h.splice(d,1)})})}function W(a,b){$.ajax({url:"http://music.baidu.com/data/music/fmlink?rate=64&songIds="+b,type:"GET",dataType:"json",success:function(b){var c=b.data.songList[0];c.lrcLink&&(c.lrcLink="http://ting.baidu.com"+c.lrcLink),A(a,c,"#SearchList")},error:function(){}})}function X(a,b){return a.fullPath==b.fullPath&&a.galleryId==b.galleryId?!0:!1}function Y(a,b){return a.songName==b.songName&&a.artistName==b.artistName&&a.albumName==b.albumName&&a.songLink.substring(0,a.songLink.indexOf("?"))==b.songLink.substring(0,b.songLink.indexOf("?"))?!0:!1}function Z(a){for(var h,i,j,k,b=a.split(/[\r\n]/),c=b.length,d={},e=[],f=0,g={ti:"",ar:"",al:""};c>f;)i=!0,j=decodeURIComponent(b[f]),k=j.replace(/\[\d*:\d*((\.|\:)\d*)*\]/g,""),"ti ar al".replace(/\S+/g,function(a){i&&""===g[a]&&(h=j.match(new RegExp("\\["+a+"\\:(.*?)\\]")),h&&h[1]&&(i=!1,g[a]=h[1]))}),0===k.length&&(k=" …… "),j.replace(/\[(\d*):(\d*)([\.|\:]\d*)*\]/g,function(){var a=0|arguments[1],b=0|arguments[2],c=60*a+b,f=e.push(1e3*c);d[e[--f]]=k.trim()}),f++;return e.sort(function(a,b){return a-b}),{words:d,times:e,data:g}}function _(a){var b,c,e,f,h,i,j,k,l,m;if($("#lrcContent").css("margin-top","240px").empty(),g.lrcData=a,b=a.words,c=a.times,a.data,e=40,f=c.length,h=0,i="",j=parseInt($("#lrcWrapper").height()/2),k=null,0!=c.length){for(;f>h;h++)l=c[h],m=b[l],l!=k&&(i+='<p id="step_'+l+'" data-lrctime="'+l+'" data-lrctop="'+j+'">'+m+"</p>",j-=e),k=l;$("#lrcContent").html(i),$("#lrcContent").children(":first-child").addClass("cur")}}function ab(a){var e,f,b="0123456789qwertyuioplkjhgfdsazxcvbnm",c="",d=b.length;for(e=0;a>e;e++)f=Math.random()*d,c+=b.charAt(Math.ceil(f)%b.length);return c}function bb(a){if(!(q.currentID<0)){var b=[];$.ajax({url:a+"&xx="+(new Date).getTime(),type:"GET",dataType:"json",success:function(a){var d,c=a.list.length>=10?10:a.list.length;for(d=0;c>d;d++)b.push(a.list[d].id);b.length&&cb(b)},statusCode:{404:function(){ob("404啊")}},error:function(){}})}}function cb(a){$.ajax({url:"http://music.baidu.com/data/music/fmlink?rate="+r.FMrate+"&songIds="+a.join()+"&xx="+(new Date).getTime(),type:"GET",dataType:"json",success:function(a){var b,c;for(q.songList=[],b=a.data.songList.length,c=0;b>c;c++)q.songList.push(a.data.songList[c]),q.songList[c].lrcLink&&(q.songList[c].lrcLink="http://ting.baidu.com"+q.songList[c].lrcLink);q.currentID=0,u.playOnlineMusic(q.songList[0],"fm")},statusCode:{404:function(){ob("404啊")}},error:function(a){ob(a)}})}function eb(a){if(r.notify){var b={type:"basic",title:a.songName,message:"歌手:"+a.artistName+"\r\n"+"专辑"+":"+a.albumName,iconUrl:"../dist/img/music_player48.png"};db++,function(a){setTimeout(function(){chrome.notifications.clear(a,function(){})},1e4)}("id"+db),chrome.notifications.create("id"+db,b,function(){})}}function nb(a){return null==a?!0:0===a.length?!0:0===Object.keys(a).length?!0:!1}function ob(a){console.log(a)}var u,db,fb,gb,hb,ib,jb,kb,lb,mb,a=0,b=null,c=[],d=[],e={},g=audio.createPlayer(),h=[],i=0,j={},k={array:[],artist:[],currentID:-1,len:0},l={array:[],currentID:-1,len:0},m=null,n=null,o=null,p=!1,q={songList:[],curFm:"",currentID:-1},r={FMrate:"128",notify:!1},s={},t={playing:function(a){if(m&&n&&o){var b={type:"playing",playerID:n,webID:o,musicInfo:a};m.emit("control",b)}},handle:function(){m?n&&($("#qrcodeLayer div.layer-body-title").empty(),$("#qrcodeLayer div.layer-body-title").html("<h3>请用手机扫二维码</h3>"),$("#qrcodeLayer div.layer-body-content").empty(),$("#qrcodeLayer div.layer-body-content").qrcode({width:128,height:128,text:"http://leolin.cc?playerID="+t.playerID}),ob("非初始化：http://leolin.cc?playerID="+n)):(m=io.connect("http://leolin.cc"),m.on("connected",function(a){n=a.id,$("#qrcodeLayer div.layer-body-title").empty(),$("#qrcodeLayer div.layer-body-title").html("<h3>请用手机扫二维码</h3>"),$("#qrcodeLayer div.layer-body-content").empty(),$("#qrcodeLayer div.layer-body-content").qrcode({width:128,height:128,text:"http://leolin.cc?playerID="+n}),ob("初始化：http://leolin.cc?playerID="+n)}),m.on("doit",function(a){var c,d,b=a.type;switch(b){case"prev":u.playPre();break;case"next":u.playNext();break;case"playPause":u.playPause();break;case"conn_ok":o=a.webID,$("#qrcodeLayer div.layer-body-title").empty(),$("#qrcodeLayer div.layer-body-title").html("<h3>远程遥控配对成功！</h3>"),m.emit("control",{webID:o,playerID:n,type:"volume",volume:t.volume.value}),g.audioEle.paused||(k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1?t.playing(k.array[k.currentID]):k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?t.playing(l.array[l.currentID]):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?t.playing(l.array[l.currentID]):q.currentID>=0&&t.playing(q.songList[q.currentID])),$("#qrcodeLayer").hide(),$(".shade").hide();break;case"conn_error":$("#qrcodeLayer div.layer-body-title").empty(),$("#qrcodeLayer div.layer-body-title").html("<h3>远程遥控配对失败！</h3>");break;case"volume":c=a.volume,t.volume.value=c,g.setVolume(c),0==c?(g.audioEle.muted=!0,t.volume.muted=!0):(g.audioEle.muted=!1,t.volume.muted=!1);break;case"showLrc":"1"==a.isOpen?(p=!0,d="302px",v(),$("#lrcWrapper").css("display","block").animate({right:"+="+d},"slow"),g.lrcStatus=!0):(p=!0,d="302px",$("#lrcWrapper").animate({right:"-="+d},"slow","swing",function(){$("#lrcContent").css("margin-top","0").empty()}),g.lrcStatus=!1)}}),m.on("disconnect",function(){$(".scanTipsLayer").empty(),$(".scanTipsLayer").html("<h2 style='color: green; background-color: #000; text-align: center;'>远程连接已断开</h2>").show(3e3,function(){$(this).hide(500)})}))},volume:{value:.5,muted:g.audioEle.muted,change:function(){g.setVolume(this.value),this.value?(g.audioEle.muted=!1,this.muted=!1):(g.audioEle.muted=!0,this.muted=!0),clearTimeout(window.volumeTimer),window.volumeTimer=setTimeout(function(){m&&m.emit("control",{webID:o,payerID:n,type:"volume",volume:t.volume.value})},300)}}};g.setSrc=function(a){var c,d,e,f,h,i,j,l;if(g.audioEle.pause(),$(".slider-range").css("width","0%"),$(".slider-handle").css("width","0%"),$("#leftPanel .icon-play").removeClass("icon-play").addClass("icon-pause"),a&&a.match("baidu.com")&&$(".download").length<=0?$(".widget").prepend('<div class="download"><a class="ctrl-btn" hidefocus="true" title="下载"><i class="icon-download-alt"></i></a></div>'):a&&!a.match("baidu.com")&&$(".download").length>0&&$(".download").remove(),g.lrcData&&g.lrcStatus&&""!=g.lrcLink)for(g.lrcData.words,c=g.lrcData.times,d=c.length,e=g.lrcContent,f=0,h=0;d>h;h++)if(i=c[h],f>i&&f<c[h+1]){j=e.children("#step_"+i),j.attr("data-lrctime"),l=j.attr("data-lrctop"),e.animate({"margin-top":l+"px"},100).find("p.cur").removeClass("cur"),j.addClass("cur");break}g.audioEle.src=a,g.audioEle.autoplay=!0},g.setCurrentTime=function(a){var b,c,e,f,h,i,j,k,l,n;if(g.audioEle.duration&&(b=parseInt($(".slider-bar").width()),c=g.audioEle.duration*a,g.audioEle.currentTime=g.audioEle.duration*a,$(".slider-range").css("width",100*a+"%"),$(".slider-handle").css("left",a*b+"px"),g.lrcData&&g.lrcStatus&&""!=g.lrcLink))for(g.lrcData.words,e=g.lrcData.times,f=e.length,h=g.lrcContent,i=0|1e3*c,j=0;f>j;j++)if(k=e[j],i>k&&i<e[j+1]){l=h.children("#step_"+k),l.attr("data-lrctime"),n=l.attr("data-lrctop"),h.animate({"margin-top":n+"px"},100).find("p.cur").removeClass("cur"),l.addClass("cur");break}},g.onTimeUpdateHandle=function(){var c,e,h,i,j,k,l,q,r,t,a=g.audioEle.currentTime,b=g.audioEle.duration;$(".slider-range").css("width",100*(a/b)+"%"),$(".slider-handle").css("left",a/b*parseInt($("#progressSlider").width())+"px"),$(".current-time").text(g.formatTime(a));try{c=g.audioEle.buffered.end(0),$(".slider-buffer").css("width",100*(c/b)+"%")}catch(d){console.log("音频缓冲错误："+d)}if(m&&o&&n&&(0!=p&&g.lrcData&&g.lrcStatus&&""!=g.lrcLink?(e=$("#lrcWrapper p.cur").html(),e&&""!=e&&m.emit("control",{type:"lrc",lrcWord:e,webID:o})):m.emit("control",{type:"lrc",lrcWord:"没有歌词哦～",webID:o})),a==b&&g.onEnded(),g.lrcData&&g.lrcStatus&&""!=g.lrcLink)for(g.lrcData.words,h=g.lrcData.times,i=h.length,j=g.lrcStep,k=g.lrcContent,l=0|1e3*a;i>j;j++)if(q=h[j],l>q&&l<h[j+1]){r=k.children("#step_"+q),r.attr("data-lrctime"),t=r.attr("data-lrctop"),k.animate({"margin-top":t+"px"},100).find("p.cur").removeClass("cur"),r.addClass("cur");break}},g.onEndedHandle=function(){var b,a=parseInt($(".play-mode li a.selected").attr("data-mode"));switch(a){case 0:if(k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1){for(b=k.currentID;(k.currentID=parseInt(Math.random()*(k.len-1)+.5))==b;);""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistName),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])}else k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?l.currentID<l.len?(l.len>1?l.currentID=parseInt(Math.random()*(l.len-1)+.5):1==l.len&&(l.currentID=0),g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):ob("不存在歌曲！"):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?kb.currentID<kb.len?(kb.len>1?kb.currentID=parseInt(Math.random()*(kb.len-1)+.5):1==kb.len&&(kb.currentID=0),g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):ob("不存在离线歌曲！"):q.currentID>=0&&(q.currentID++,q.currentID>9?bb(q.curFm):u.playOnlineMusic(q.songList[q.currentID],"fm"),t.playing(q.songList[q.currentID]));break;case 1:g.setLoop(),g.play();break;case 2:k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1?(k.currentID=k.currentID+1>=k.len?0:k.currentID+1,""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistName),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])):k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?(l.currentID=l.currentID+1>=l.len?0:l.currentID+1,g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?(kb.currentID=kb.currentID+1>=kb.len?0:kb.currentID+1,g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):q.currentID>=0&&(q.currentID++,q.currentID>9?bb(q.curFm):u.playOnlineMusic(q.songList[q.currentID],"fm"),t.playing(q.songList[q.currentID]))}g.lrcStatus&&v()},u={mode:parseInt($(".play-mode li a.selected").attr("data-mode")),playPre:function(){var a,b;switch(this.mode){case 0:if(k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1){for(a=k.currentID;(k.currentID=parseInt(Math.random()*(k.len-1)+.5))==a;);""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistName),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])}else k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?l.currentID<l.len?(l.len>1?l.currentID=parseInt(Math.random()*(l.len-1)+.5):1==l.len&&(l.currentID=0),g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):ob("不存在歌曲！"):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?kb.currentID<kb.len?(kb.len>1?kb.currentID=parseInt(Math.random()*(kb.len-1)+.5):1==kb.len&&(kb.currentID=0),g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):ob("不存在歌曲！"):q.currentID>=0&&(q.currentID++,q.currentID>9?bb(q.curFm):u.playOnlineMusic(q.songList[q.currentID],"fm"),t.playing(q.songList[q.currentID]));break;case 1:b=g.getSrc(),b&&(g.setSrc(b),g.play());break;case 2:k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1?(k.currentID=k.currentID-1<0?k.len-1:k.currentID-1,""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistName),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])):k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?(l.currentID=l.currentID-1<0?l.len-1:l.currentID-1,g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?(kb.currentID=kb.currentID-1<0?kb.len-1:kb.currentID-1,g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):q.currentID>=0&&(q.currentID++,q.currentID>9?bb(q.curFm):u.playOnlineMusic(q.songList[q.currentID],"fm"),t.playing(q.songList[q.currentID]))}g.lrcStatus&&v()},playNext:function(){var a,b;switch(this.mode){case 0:if(k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1){for(a=k.currentID;(k.currentID=parseInt(Math.random()*(k.len-1)+.5))==a;);""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistName),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])}else k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?l.currentID<l.len?(l.len>1?l.currentID=parseInt(Math.random()*(l.len-1)+.5):1==l.len&&(l.currentID=0),g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):ob("不存在歌曲！"):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?kb.currentID<kb.len?(kb.len>1?kb.currentID=parseInt(Math.random()*(kb.len-1)+.5):1==kb.len&&(kb.currentID=0),g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):ob("不存在歌曲！"):q.currentID>=0&&(q.currentID++,q.currentID>9?bb(q.curFm):u.playOnlineMusic(q.songList[q.currentID],"fm"),t.playing(q.songList[q.currentID]));break;case 1:b=g.getSrc(),b&&(g.setSrc(b),g.play());break;case 2:k.currentID>=0&&l.currentID<=-1&&kb.currentID<=-1?(k.currentID=k.currentID+1>=k.len?0:k.currentID+1,""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistname),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])):k.currentID<=-1&&l.currentID>=0&&kb.currentID<=-1?(l.currentID=l.currentID+1>=l.len?0:l.currentID+1,g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):k.currentID<=-1&&l.currentID<=-1&&kb.currentID>=0?(kb.currentID=kb.currentID+1>=kb.len?0:kb.currentID+1,g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):q.currentID>=0&&(q.currentID++,q.currentID>9?(q.currentID=0,bb(q.curFm)):u.playOnlineMusic(q.songList[q.currentID],"fm"),t.playing(q.songList[q.currentID]))}g.lrcStatus&&v()},playPause:function(){k.currentID<=-1&&l.currentID<=-1&&q.currentID<=-1&&kb.currentID<=-1?k.len>0?(k.currentID=0,""==k.array[k.currentID].lrcLink&&w(k.array[k.currentID].songName,k.array[k.currentID].artistname),g.lrcLink=k.array[k.currentID].lrcLink,E(k.array[k.currentID].galleryId,k.array[k.currentID].fullPath),eb(k.array[k.currentID]),t.playing(k.array[k.currentID])):l.len>0?(l.currentID=0,g.setSrc(l.array[l.currentID].songLink),g.lrcLink=l.array[l.currentID].lrcLink,$(".title .artist").text(l.array[l.currentID].artistName),$(".title .songname").text(l.array[l.currentID].songName),eb(l.array[l.currentID]),t.playing(l.array[l.currentID])):kb.len>0&&(kb.currentID=0,g.setSrc(kb.array[kb.currentID].songLink),g.lrcLink=kb.array[kb.currentID].lrcLink,$(".title .artist").text(kb.array[kb.currentID].artistName),$(".title .songname").text(kb.array[kb.currentID].songName),eb(kb.array[kb.currentID]),t.playing(kb.array[kb.currentID])):g.audioEle.paused?g.play():g.pause()},playOnlineMusic:function(a,b){var c="#leftPanel .play-btn .play-pause a";$(c).children().removeClass("icon-play").addClass("icon-pause"),$(c).attr("title","暂停"),$(c).parent().removeClass("play").addClass("pause"),g.setSrc(a.songLink),g.lrcLink=a.lrcLink,g.lrcStatus&&v(),$("#playTitle .title .songname").text(a.songName),$("#playTitle .title .artist").text(a.artistName),"fm"==b?(k.currentID=-1,kb.currentID=-1,l.currentID=-1):"myLike"==b&&(k.currentID=-1,kb.currentID=-1,q.currentID=-1),eb(a),t.playing(a)}},function(){$("#local").addClass("menu-active"),$("#onlineBody").hide(),$("#leftCol2-songList").show(),$("#leftCol2-singerList").hide(),$("#leftCol2-recycleList").hide(),$(".shade").hide(),$(".layer").hide(),$(".scanTipsLayer").hide(),chrome.mediaGalleries.getMediaFileSystems({interactive:"no"},I),M(),$.indexedDB("localMusicDB").objectStore("musicList").count().done(function(a){0==a?ob("Add songs please!"):F(k,"localMusic")}),N(),$.indexedDB("onlineMusicDB").objectStore("musicList").count().done(function(a){0==a?ob("没有在线歌曲!"):F(l,"onlineMusic")}),O(),$.indexedDB("recycleMusicDB").objectStore("musicList").count().done(function(a){0==a?ob("没有回收站歌曲～"):F(h,"recycleMusic")}),Q(),$.indexedDB("categoryDB").objectStore("categoryList").each(function(a){$("#toggle ul").append("<li data-catid="+a.value.id+"><p class='cat-list-name'>"+a.value.name+"</p><input type='text' class='edit-name' id='editName_"+a.value.id+"' value='"+a.value.name+"' style='display: none;'><div class='edit-icons' style='display: none;'><a hidefocus='true' class='edit-change'><i class='icon-edit'></i></a><a hidefocus='true' class='edit-delete'><i class='icon-remove-2'></i></a></div></li>")}).done(),P(),$.indexedDB("offlineMusicDB").objectStore("musicList").each(function(a){kb.array.push(a.value),kb.len++}).done(function(){$("#OfflineList").empty(),H()})}(),$("#local,#online").click(function(){$(this).addClass("menu-active").siblings().removeClass("menu-active");var b=$(this).attr("id");$("#"+b+"Body").show().siblings().hide(),"online"==b&&($("#popular").addClass("list-active").siblings().removeClass("list-active"),$("#leftCol2-popular").show().siblings().hide())}),$(".leftbar-outer > div").click(function(){var b=$(this).attr("id");return"toggle"==b?!1:($(this).addClass("list-active").siblings().removeClass("list-active"),"allSong"==b?$("#toggle").slideToggle(400):($("#toggle .toggle-active").removeClass("toggle-active"),$("#leftCol2-"+b).show().siblings().hide(),"recycleList"==b?($("#RecycleList").empty(),G()):"offlineList"==b?kb.len||kb.downloading||$("#OfflineList h3").length?kb.len&&!kb.downloading&&($("#OfflineList").empty(),H()):$("#OfflineList").prepend("<h3>没有歌曲哦～</h3>"):"singerList"==b&&(k.artist=[],$.indexedDB("localMusicDB").objectStore("musicList").each(function(a){-1==k.artist.indexOf(a.value.artistName)&&(k.artist.push(a.value.artistName),$(".singer-list").append('<div class="singer-list-row"><div class="singername"><span>'+a.value.artistName+"</span></div></div>"))}))),void 0)}),$("#toggle").on("click","li",function(a){a.preventDefault();var b=$(this).attr("data-catid");$(".leftbar-outer > div#allSong").addClass("list-active").siblings().removeClass("list-active"),$(this).addClass("toggle-active").siblings().removeClass("toggle-active"),$("#leftCol2-"+b).show().siblings().hide()}),$("#toggle").on("mouseenter","li",function(a){a.preventDefault(),$(this).children(".edit-icons").show()}),$("#toggle").on("mouseleave","li",function(a){a.preventDefault(),$(this).children(".edit-icons").hide()}),$("#addCat").on("click","p",function(a){a.preventDefault(),$(this).hide(),$("#addCat input").show().focus()}),$("#addCat input").blur(function(){$(this).hide(),$("#addCat p").show()}),$("#addCat input").on("keydown",function(a){var c,d,b=a.keyCode;switch(b){case 27:$("#addCat input").hide(),$("#addCat p").show(),$("#addCat input").val("我的歌单");break;case 13:c=$.trim($("#addCat input").val()),c&&""!=c&&(d=ab(6),$.indexedDB("categoryDB").objectStore("categoryList").add({id:d,name:c}).done(function(){$("#toggle ul").append("<li data-catid="+d+"><p class='cat-list-name'>"+c+"</p><input type='text' class='edit-name' id='editName_"+d+"' value='"+c+"' style='display: none;'><div class='edit-icons' style='display: none;'><a hidefocus='true' class='edit-change'><i class='icon-edit'></i></a><a hidefocus='true' class='edit-delete'><i class='icon-remove-2'></i></a></div></li>"),$("#addCat input").hide(),$("#addCat p").show(),$("#addCat input").val("我的歌单")}))}}),$("#toggle").on("click",".edit-change",function(a){a.preventDefault();var b=$(this);b.parent().siblings(".cat-list-name").css("display","none"),b.parent().siblings(".edit-name").css("display","block")}),$("#toggleList").on("focus","li input",function(a){a.preventDefault();var b=$(this).attr("id");$("#toggleList").on("keydown","#"+b,function(a){var f,g,c=a.keyCode,d=b.slice(9),e=$(this);switch(c){case 27:e.hide(),e.siblings("p").show();break;case 13:f=$.trim($(this).val()),f&&""!=f&&(g=null,$.indexedDB("categoryDB").objectStore("categoryList").each(function(a){return a.value.id==d?(g=a.key,!1):void 0}).done(function(){g&&$.indexedDB("categoryDB").objectStore("categoryList").put({id:d,name:f},g).done(function(){e.attr("value",f).hide(),e.siblings("p").text(f).show()
})}))}})}),$("#toggleList").on("blur","li input",function(a){a.preventDefault(),$(this).hide(),$(this).siblings("p").show()}),$("#GalleryList").on("click",".song-cat",function(a){var b,c,d,e,f,g;a.preventDefault(),b=$(this).offset().top+10,c=$(this).offset().left+25,d=.4*$(document).height(),e=$(this).parent("div"),f=$("#catPop ul"),g=0,f.empty(),$.indexedDB("categoryDB").objectStore("categoryList").each(function(a){g++,f.append('<li id="catList_'+a.value.id+'"><a hidefocus="true">'+a.value.name+"</a></li>")}).done(function(){var a,h,i;g>0&&(a=31*g>=d?d:31*g,h=e.attr("data-fullpath"),i=e.attr("data-galleryid"),f.attr({"data-fullpath":h,"data-galleryid":i}),b+a>=$(document).height()?$("#catPop").css({top:b-a+"px",left:c+"px"}).show():$("#catPop").css({top:b+"px",left:c+"px"}).show())})}),$("#catPop").on("click","ul li",function(a){var b,c,d,e,f;a.preventDefault(),b=$(this).attr("id").slice(8),c=$(this).parent("ul").attr("data-galleryid"),d=$(this).parent("ul").attr("data-fullpath"),e=null,f=null,$.indexedDB("localMusicDB").objectStore("musicList").each(function(a){return a.value.galleryId==c&&a.value.fullPath==d?(e=a.key,f=a.value,!1):void 0}).done(function(){e&&f&&(f.catID=b,$.indexedDB("localMusicDB").objectStore("musicList").put(f,e).done(function(){$("#catPop").hide(),$("#catPop ul").empty()}))})}),$("#toggle").on("click",".edit-delete",function(a){var b,c,d;a.preventDefault(),b=$(this),c=b.parent().parent("li").attr("data-catid"),d=null,$.indexedDB("categoryDB").objectStore("categoryList").each(function(a){return a.value.id==c?(d=a.key,!1):void 0}).done(function(){d&&$.indexedDB("categoryDB").objectStore("categoryList").delete(d).done(function(){"toggle-active"==b.parent().parent("li").attr("class")&&($("#songList").addClass("toggle-active").siblings().removeClass("toggle-active"),$("#leftCol2-songList").show().siblings().hide()),b.parent().parent("li").remove()})})}),$("#toggleList").on("click",".cat-list-name",function(a){a.preventDefault();var b=$(this).parent("li").attr("data-catid"),c=0;"songList"==$(this).parent("li").attr("id")?$("#leftCol2-songList").show().siblings().hide():($("#catMusicList").empty(),$.indexedDB("localMusicDB").objectStore("musicList").each(function(a){a.value.catID==b&&(A(c,a.value,"#catMusicList"),c++)}).done(function(){c||$("#catMusicList").html("<h3>没有歌曲哦～</h3>"),$("#leftCol2-cat").show().siblings().hide()}))}),$("#openFile").click(function(){chrome.mediaGalleries.getMediaFileSystems({interactive:"if_needed"},I),$(".shade").show(),$("#openFileLayer").show("slow")}),$("#addBtn").click(function(){chrome.mediaGalleries.getMediaFileSystems({interactive:"yes"},I)}),$("#scanBtn").click(function(){d.length>0&&B(e[d[0]]),$(".shade").hide(),$(".layer").hide()}),$(".cancel-btn").click(function(){$(".shade").hide(),$(".layer").hide()}),$("#GalleryList, #singerListViewport, #SearchList, #MyLikeList, #catMusicList").on("dblclick",".list-row",function(a){var b,c,d;a.preventDefault(),$("#fm-playing").length>0&&$("#fm-playing").remove(),$("#lrcContent").css("margin-top","250px").empty(),g.lrcLink="",$(this).parent("#SearchList").length>0||$(this).parent("#MyLikeList").length>0?(b={songLink:$(this).attr("data-src"),lrcLink:$(this).attr("data-lrc"),songName:$(this).children("div.list-cell.c0").text(),artistName:$(this).children("div.list-cell.c1").text(),albumName:$(this).children("div.list-cell.c2").text()},s=$(this).parent("#SearchList").length>0?b:{},u.playOnlineMusic(b,"myLike"),$(this).parent("#MyLikeList")&&(l.currentID=T(b),k.currentID=-1,kb.currentID=-1,q.currentID=-1),g.lrcStatus&&v(),t.playing(b)):(c=".play-btn .play-pause a",$(c).children().removeClass("icon-play").addClass("icon-pause"),$(c).attr("title","暂停"),$(c).parent().removeClass("play").addClass("pause"),b={},b=$(this).parent("#singerListViewport").length>0?{songName:$(this).children("div.list-cell.c00").text(),artistName:$(this).children("div.list-cell.c11").text(),galleryId:$(this).attr("data-galleryid"),lrcLink:$(this).attr("data-lrc"),fullPath:$(this).attr("data-fullpath")}:{songName:$(this).children("div.list-cell.c0").text(),artistName:$(this).children("div.list-cell.c1").text(),galleryId:$(this).attr("data-galleryid"),lrcLink:$(this).attr("data-lrc"),fullPath:$(this).attr("data-fullpath")},d=$(this),k.currentID=S(b),l.currentID=-1,kb.currentID=-1,q.currentID=-1,""==$(this).attr("data-lrc")?w(b,d):g.lrcLink=$(this).attr("data-lrc"),g.lrcStatus&&v(),E($(this).attr("data-galleryid"),$(this).attr("data-fullpath")),t.playing(b),$(".title .songname").text(b.songName),$(".title .artist").text(b.artistName),s={})}),$("#OfflineList").on("dblclick",".complete-offline-list-row",function(a){a.preventDefault();var b=$(this);g.lrcLink="",lb.readFileAsUrl(b.attr("data-songname"),function(a,c){var e,d=".play-btn .play-pause a";$(d).children().removeClass("icon-play").addClass("icon-pause"),$(d).attr("title","暂停"),$(d).parent().removeClass("play").addClass("pause"),e={songName:b.attr("data-songname"),artistName:b.attr("data-artistname"),albumName:b.attr("data-albumname"),lrcLink:b.attr("data-lrc")},kb.currentID=R(e),g.setSrc(c),g.play(),g.lrcLink=b.attr("data-lrc"),g.lrcStatus&&v(),t.playing(e),$(".title .songname").text(e.songName),$(".title .artist").text(e.artistName),s={}})}),$("ul").on("click",".pause .ctrl-btn",function(a){a.preventDefault(),$(this).children().removeClass("icon-pause").addClass("icon-play"),$(this).attr("title","播放"),$(this).parent().removeClass("pause").addClass("play"),g.pause()}),$("ul").on("click",".play .ctrl-btn",function(a){a.preventDefault(),$(this).children().removeClass("icon-play").addClass("icon-pause"),$(this).attr("title","暂停"),$(this).parent().removeClass("play").addClass("pause"),g.play()}),$(document).on("keydown",function(a){var b,c;32==a.keyCode?$("input").is(":focus")||(a.preventDefault(),b=".play-btn .play-pause a",$(".play-btn .play-pause").hasClass("pause")?($(b).children().removeClass("icon-pause").addClass("icon-play"),$(b).attr("title","播放"),$(b).parent().removeClass("pause").addClass("play"),g.pause()):k.currentID<=-1&&l.currentID<=-1?($(b).children().removeClass("icon-play").addClass("icon-pause"),$(b).attr("title","暂停"),$(b).parent().removeClass("play").addClass("pause"),u.playPause()):($(b).children().removeClass("icon-play").addClass("icon-pause"),$(b).attr("title","暂停"),$(b).parent().removeClass("play").addClass("pause"),g.play())):37==a.keyCode?$("input").is(":focus")||u.playPre():39==a.keyCode?$("input").is(":focus")||u.playNext():38==a.keyCode?(a.preventDefault(),c="0px"===$(".vol-slider-range").css("width")?0:parseInt($(".vol-slider-range").css("width"))/parseInt($(".vol-slider-wrapper").width()),g.setVolume(c+.1)):40==a.keyCode?(a.preventDefault(),c="0px"===$(".vol-slider-range").css("width")?0:parseInt($(".vol-slider-range").css("width"))/parseInt($(".vol-slider-wrapper").width()),g.setVolume(c-.1)):27==a.keyCode&&(a.preventDefault(),"block"==$("#catPop").css("display")&&($("#catPop").hide(),$("#catPop ul").empty()))}),$("ul").on("click",".prev .ctrl-btn",function(a){a.preventDefault(),u.playPre()}),$("ul").on("click",".next .ctrl-btn",function(a){a.preventDefault(),u.playNext()}),$("#progressSlider").drag({parent:".progress-wrapper",handler:".slider-handle",range:".slider-range",bar:".slider-bar",X:!0,maxLeft:parseInt($(".slider-bar").offset().left),maxRight:parseInt($(".slider-bar").offset().left)+parseInt($(".slider-bar").width()),callback:function(){var a="0px"===$(".slider-range").css("width")?0:parseInt($(".slider-range").css("width"))/parseInt($(".slider-bar").width());g.setCurrentTime(a)}}),$("#progressSlider").on("click",function(a){var b,c,d;return a.preventDefault(),b=parseInt($(".slider-bar").offset().left),c=parseInt($(".slider-bar").width()),a.pageX<b||a.pageX>b+c?!1:(d=(a.pageX-b)/c,g.setCurrentTime(d),void 0)}),$(".vol-slider-wrapper").drag({parent:"#volumeWrapper",handler:".vol-slider-handle",range:".vol-slider-range",bar:"#volSlider",X:!0,maxLeft:parseInt($(".vol-slider-wrapper").offset().left),maxRight:parseInt($(".vol-slider-wrapper").offset().left)+parseInt($(".vol-slider-wrapper").width()),callback:function(){var a="0px"===$(".vol-slider-range").css("width")?0:parseInt($(".vol-slider-range").css("width"))/parseInt($(".vol-slider-wrapper").width());g.setVolume(a)}}),$("#volumeWrapper").on("click",function(a){var b,c,d;return a.preventDefault(),b=parseInt($("#volSlider").offset().left),c=parseInt($("#volSlider").width()),a.pageX<b||a.pageX>b+c?!1:(d=(a.pageX-b)/c,g.setVolume(d),void 0)}),$("#volumeWrapper").on("click","a i.icon-mute",function(a){a.preventDefault(),g.setVolume(.5)}),$("#volumeWrapper").on("click","a i.icon-volume-down,a i.icon-volume-up",function(a){a.preventDefault(),g.setVolume(0)}),$("ul.play-mode li").on("click","a",function(a){a.preventDefault(),$(this).hasClass("selected")||($("ul.play-mode li a.selected").removeClass("selected"),$(this).addClass("selected"))}),$("#leftCol2-singerList").on("click",".singer-list-row",function(a){a.preventDefault();var b=$(this).children(".singername").text();$("#singerListViewport").empty(),$.indexedDB("localMusicDB").objectStore("musicList").index("artistName").each(function(a){$("#singerListViewport").append('<div class="list-row" data-lrc="'+a.value.lrcLink+'" data-fullpath="'+a.value.fullPath+'" data-galleryid="'+a.value.galleryId+'"><div class="list-cell c00"><span class="list-songname">'+a.value.songName+'</span></div><div class="list-cell c11"><span class="list-songname">'+a.value.albumName+"</span></div></div>")},b).done(function(){})}),$("#leftCol2-songList,#leftCol2-singerList").on("click",".song-delete",function(a){var b,c;a.preventDefault(),b=$(this).parent(".list-row").attr("data-galleryid"),c=$(this).parent(".list-row").attr("data-fullpath"),J(b,c),$(this).parent(".list-row").remove()}),$("#RecycleList").on("click",".song-delete",function(a){var b,c;a.preventDefault(),b=$(this).parent(".list-row").attr("data-galleryid"),c=$(this).parent(".list-row").attr("data-fullpath"),U(b,c),$(this).parent(".list-row").remove()}),$("#RecycleList").on("click",".song-restore",function(a){var b,c;a.preventDefault(),b=$(this).parent(".list-row").attr("data-galleryid"),c=$(this).parent(".list-row").attr("data-fullpath"),L(b,c),$(this).parent(".list-row").remove()}),$(".widget").on("click",".fullscreen",function(a){a.preventDefault(),chrome.app.window.current().isFullscreen()?($(this).children("a").attr("title","全屏"),chrome.app.window.current().restore()):($(this).children("a").attr("title","退出全屏"),chrome.app.window.current().fullscreen())}),$("#search").on("focus","#searchInput",function(){var b=$(this);$("#searchInput").on("keydown",b,function(a){if(13==a.keyCode){var c=$.trim(b.val());$.ajax({url:"http://mp3.baidu.com/dev/api/?tn=getinfo&ct=0&ie=utf-8&format=json&word="+c,type:"GET",dataType:"json",beforeSend:function(){$("#online").addClass("menu-active").siblings().removeClass("menu-active"),$("#search-result").addClass("list-active").siblings().removeClass("list-active"),$("#SearchList").empty().html("<h3>正在搜索～</h3>"),$("#onlineBody").show().siblings().hide(),$("#leftCol2-search-result").show().siblings().hide()},success:function(a){a.length?($("#SearchList").empty(),a.forEach(function(a){W(0,a.song_id)})):$("#SearchList").empty().html("<h3>没有结果哦～</h3>")},error:function(){}})}})}),$(".list-viewport").on("click",".song-like",function(a){var b,c;a.preventDefault(),$(this).toggleClass("song-like-active"),b={songName:$(this).siblings("div.list-cell.c0").text(),artistName:$(this).siblings("div.list-cell.c1").text(),albumName:$(this).siblings("div.list-cell.c2").text(),songLink:$(this).parent().attr("data-src"),lrcLink:$(this).parent().attr("data-lrc")},$(this).hasClass("song-like-active")&&(c=!1,$.indexedDB("onlineMusicDB").objectStore("musicList").each(function(a){return Y(a.value,b)?(c=!0,!1):void 0}).done(function(){c?ob("已存在不能重复添加！"):$.indexedDB("onlineMusicDB").objectStore("musicList").add(b).done(function(){var a=l.len;A(a,b,"#MyLikeList"),l.array.push(b),l.len++})}))}),$("#MyLikeList").on("click",".song-delete",function(a){var b,c,d,e;a.preventDefault(),b={songName:$(this).siblings("div.list-cell.c0").text(),artistName:$(this).siblings("div.list-cell.c1").text(),albumName:$(this).siblings("div.list-cell.c2").text(),songLink:$(this).parent().attr("data-src"),lrcLink:$(this).parent().attr("data-lrc")},c=!1,d=$(this),e=-1,$.indexedDB("onlineMusicDB").objectStore("musicList").each(function(a){return Y(a.value,b)?(c=!0,e=a.key,!1):void 0}).done(function(){c&&-1!=e?$.indexedDB("onlineMusicDB").objectStore("musicList").delete(e).done(function(){d.parent(".list-row").remove();var e=T(b);e>=0&&(l.array.splice(e,1),l.len--)}):ob("不存在怎么能删除呢～")})}),$("#MyLikeList").on("click",".song-add",function(a){var b,c;a.preventDefault(),b=$(this).parent(".list-row"),c={songLink:b.attr("data-src"),lrcLink:b.attr("data-lrc"),songName:b.children("div.c0").text(),artistName:b.children("div.c1").text(),albumName:b.attr("data-albumname")},u.playOnlineMusic(c,"myLike"),l.currentID=T(c),k.currentID=-1,kb.currentID=-1,q.currentID=-1,g.lrcStatus&&v(),t.playing(c)}),$(".widget").on("click",".lrc",function(a){a.preventDefault();var b="302px";g.lrcStatus?($("#lrcWrapper").animate({right:"-="+b},"slow","swing",function(){$("#lrcContent").css("margin-top","250px").empty()}),g.lrcStatus=!1,o&&n&&m&&(m.emit("control",{type:"showLrc",playerID:n,webID:o,isOpen:"0"}),p=!1)):(v(),$("#lrcWrapper").css("display","block").animate({right:"+="+b},"slow"),g.lrcStatus=!0,o&&n&&m&&(m.emit("control",{type:"showLrc",webID:o,isOpen:"1"}),p=!0))}),$("#menu").on("click","#QRCode",function(a){a.preventDefault(),$(".shade").show(),$("#qrcodeLayer").show("slow"),$("#qrcodeLayer div.layer-body-title").html("<h4>正在获取二维码......</h4>"),$("#qrcodeLayer div.layer-body-content").empty(),t.handle()}),$("#leftCol2-fm").on("dblclick",".other-list-row",function(a){a.preventDefault(),q.curFm=$(this).attr("data-link"),$("#fm-playing").length<=0&&"fm-playing"!=$(this).children("span:first-child").attr("id")?$(this).prepend('<span id="fm-playing"><i class="icon-note"></i></span>'):$("#fm-playing").length>0&&($("#fm-playing").remove(),$(this).prepend('<span id="fm-playing"><i class="icon-note"></i></span>')),q.currentID=0,bb(q.curFm)}),$("#menu").on("click","#setting",function(a){a.preventDefault(),$("#settingLayer").show("slow"),$(".shade").show()}),$("#settingLayer").on("click",".ok-btn",function(a){a.preventDefault(),r.notify=$("#settingNotify").is(":checked")?!0:!1;var b=$("input[name=setting-quality]:checked","#settingLayer").val();b!=r.FMrate&&(r.FMrate=b,bb(q.curFm)),$("#settingLayer").hide(),$(".shade").hide()}),db=0,gb=1073741824,ib="offline",jb={used:0,total:gb},kb={array:[],currentID:-1,len:0,downloading:!1},window.StorageInfo=window.navigator.webkitPersistentStorage||window.StorageInfo||window.webkitStorageInfo,window.StorageInfo.queryUsageAndQuota(function(a,b){gb>b&&(gb=b/3),jb.total=gb,window.webkitRequestFileSystem(PERSISTENT,gb,function(a){fb=a,a.root.getDirectory(ib,{create:!0},function(a){hb=a},x)},x)},x),lb={writeFile:function(a,b,c){fb.root.getFile(ib+"/"+a+".mp3",{create:!0},function(a){a.createWriter(function(a){a.onwriteend=function(){console.log("Write completed."),c()},a.onerror=function(a){console.log("Write failed: "+a.toString())},a.write(b)})})},remove:function(a,b){fb.root.getFile(ib+"/"+a+".mp3",{create:!1},function(a){a.remove(function(){b()})})},readFileAsUrl:function(a,b){fb.root.getFile(ib+"/"+a+".mp3",{},function(a){a.file(function(a){var c=window.webkitURL.createObjectURL(a);b(null,c)})})},wipe:function(a){hb.removeRecursively(function(){a()})}},mb=function(a,b){var c,d,e;$("#local").addClass("menu-active").siblings().removeClass("menu-active"),$("#localBody").show().siblings().hide(),$("#offlineList").addClass("list-active").siblings().removeClass("list-active"),$("#leftCol2-offlineList").show().siblings().hide(),c=ab(4),d=$('<div id="downloadingID_'+c+'" class="offline-list-row"><div class="list-cell c0">'+b.songName+'</div><div class="list-cell c1">'+b.artistName+'</div><div class="list-cell c2"><progress max="100" value="0" style="width: 20em"></progress></div></div>'),$("#OfflineList h3").length>0&&$("#OfflineList").empty(),$("#OfflineList").prepend(d),kb.downloading=!0,e=new XMLHttpRequest,e.open("GET",a),e.responseType="blob",e.onreadystatechange=function(){return 200!=e.status?($("#downloadingID_"+c+" progress").remove(),$("#downloadingID_"+c+" div.c2").html("资源出错"),e.abort(),void 0):void 0},e.onload=function(){var a=this.response.size;return jb.used+a>gb?(ob("outofspace"),d.remove(),e.abort(),void 0):(lb.writeFile(b.songName,this.response,function(){$.indexedDB("offlineMusicDB").objectStore("musicList").add({albumName:b.albumName,artistName:b.artistName,lrcLink:b.lrcLink,songLink:b.songLink,songName:b.songName}).done(function(){d.remove(),kb.len++;var e=$('<div class="offline-list-row complete-offline-list-row" data-lrc="'+b.lrcLink+'" data-songname="'+b.songName+'" data-artistname="'+b.artistName+'" data-albumname="'+b.albumName+'"><div class="list-cell c0">'+b.songName+'</div><div class="list-cell c1">'+b.artistName+'</div><div class="list-cell c2">完成</div><div class="song-delete"><span class="delete"><i class="icon-remove-2"></i></span></div></div>');$("#OfflineList").prepend(e),kb.array.push({albumName:b.albumName,artistName:b.artistName,lrcLink:b.lrcLink,songLink:b.songLink,songName:b.songName}),kb.downloading=!1})}),void 0)},e.onprogress=function(a){$("#downloadingID_"+c).find("progress").attr({max:a.totalSize,value:a.loaded})},e.send()},$(".widget").on("click",".download",function(a){var b,c;a.preventDefault(),b=g.getSrc(),c={},b&&(q.currentID>=0&&l.currentID<0?c=q.songList[q.currentID]:q.currentID<0&&l.currentID>=0?c=l.array[l.currentID]:nb(s)||(c=s),mb(c.songLink,c))}),$("#OfflineList").on("click",".song-delete",function(a){var b,c,d;a.preventDefault(),b=$(this).parent(".complete-offline-list-row"),c={songName:b.attr("data-songname"),artistName:b.attr("data-artistname"),albumName:b.attr("data-albumname")},d=null,$.indexedDB("offlineMusicDB").objectStore("musicList").each(function(a){return a.value.songName==c.songName&&a.value.artistName==c.artistName&&a.value.albumName==c.albumName?(d=a.key,!1):void 0}).done(function(){d&&$.indexedDB("offlineMusicDB").objectStore("musicList").delete(d).done(function(){lb.remove(c.songName,function(){var a=R(c);kb.array.splice(a,1),kb.len--,b.remove()})})})})});